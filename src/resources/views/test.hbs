<div class="container mt-5">
  <h2>Tìm kiếm sản phẩm</h2>
  <form id="fileUploadForm" action="search">
    <div class="form-group">
      <label for="fileInput">Hình ảnh:</label>
      <input type="file" id="fileInput" class="form-control-file" accept="image/*" name="img">
    </div>
    <div id="fileInfo" class="mt-3"></div>
    <button type="submit"
      style="background-color: #131313; color: #fff; margin-top: 30px; width: 170px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; border-radius: 0; cursor: pointer; box-sizing: border-box; font-size: 16px;">
      Tìm kiếm
    </button>
    <input id="text" name="text" type="hidden"> <!-- Set text field as hidden -->
  </form>
  
  <div id="predictionResult" class="mt-3"></div>
</div>

<script>
  document.getElementById('fileInput').addEventListener('change', function (event) {
    const file = event.target.files[0]; // Get the selected file
    const fileInfo = document.getElementById('fileInfo');

    // Clear previous file info and image
    fileInfo.innerHTML = '';

    if (file) {
      // Display file info
      fileInfo.innerHTML = `
        <p>File: ${file.name}</p>
      `;

      // Create a FileReader to read the file and display a preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result; // Set the source to the file data
        img.style.maxWidth = '200px'; // Limit the image size
        img.style.marginTop = '10px'; // Add some margin
        fileInfo.appendChild(img); // Append the image to the fileInfo div
      };
      reader.readAsDataURL(file); // Read the file as a data URL
    } else {
      fileInfo.innerHTML = '<p>No file chosen.</p>'; // No file selected
    }
  });

  document.getElementById('fileUploadForm').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent the form from submitting immediately

    const fileInput = document.getElementById('fileInput');
    const predictionResult = document.getElementById('predictionResult');

    if (fileInput.files.length > 0) { // Check if a file was chosen
      const file = fileInput.files[0]; // Access the first file

      // Send the file to the API
      const formData = new FormData();
      formData.append('image', file);

      fetch('http://127.0.0.1:5000/predict', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // Update the text field with the prediction results
        let clothing_type = data.clothing_type;
        let clothing_color = data.color;
        let tmp=clothing_type+' '+clothing_color;
        tmp = tmp.replace(/_/g, " ");
        const text = document.getElementById('text');

        text.value = `${tmp}`; // Set the text field

        // Submit the form after setting the text value
        document.getElementById('fileUploadForm').submit();
      })
      .catch(error => {
        console.error('Error:', error);
        predictionResult.innerHTML = '<p>An error occurred while processing the image.</p>';
      });

    } else {
      predictionResult.innerHTML = '<p>No file chosen.</p>'; // No file selected
    }
  });
</script>
